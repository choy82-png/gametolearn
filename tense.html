import React, { useState, useEffect, useRef } from 'react';
import * as Tone from 'tone';
import html2canvas from 'html2canvas';

// Main App component
const App = () => {
  // Game state variables
  const [playerName, setPlayerName] = useState('');
  const [playerClass, setPlayerClass] = useState('');
  const [currentPage, setCurrentPage] = useState('intro'); // 'intro', 'game', 'scorecard'
  const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
  const [score, setScore] = useState(0);
  const [showFeedback, setShowFeedback] = useState(false);
  const [isCorrect, setIsCorrect] = useState(false);
  const [isMusicPlaying, setIsMusicPlaying] = useState(false);
  const musicPlayerRef = useRef(null);
  const scorecardRef = useRef(null);

  // A simple background music melody
  const melody = [
    { note: "C4", duration: "4n" },
    { note: "D4", duration: "8n" },
    { note: "E4", duration: "8n" },
    { note: "G4", duration: "4n" },
    { note: "E4", duration: "4n" },
    { note: "D4", duration: "4n" },
    { note: "C4", duration: "2n" },
  ];

  // Initialize the music player
  useEffect(() => {
    // Only set up Tone.js if it hasn't been initialized already
    if (!musicPlayerRef.current) {
      const synth = new Tone.Synth({
        oscillator: { type: "triangle" },
        envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 },
      }).toDestination();

      const sequence = new Tone.Sequence((time, noteInfo) => {
        synth.triggerAttackRelease(noteInfo.note, noteInfo.duration, time);
      }, melody).start(0);

      // Store the player and sequence in a ref
      musicPlayerRef.current = { synth, sequence };
    }
  }, []);

  // Questions for the game
  const questions = [
    {
      type: 'identify',
      prompt: 'Identify the past tense verb in the sentence:',
      sentence: 'The dog jumped over the fence.',
      correctAnswer: 'jumped',
      options: ['The', 'dog', 'jumped', 'over'],
      helpText: 'Hint: The verb shows an action that already happened.',
    },
    {
      type: 'identify',
      prompt: 'Identify the present tense verb in the sentence:',
      sentence: 'He reads a book every night.',
      correctAnswer: 'reads',
      options: ['He', 'reads', 'book', 'every'],
      helpText: 'Hint: The verb shows an action happening now or a regular habit.',
    },
    {
      type: 'fill',
      prompt: 'Complete the sentence with the correct tense:',
      sentence: 'Yesterday, we went to the park.',
      verb: 'go',
      correctAnswer: 'went',
      options: ['go', 'went', 'going', 'goes'],
      helpText: 'Hint: "Yesterday" tells you the action happened in the past.',
    },
    {
      type: 'fill',
      prompt: 'Complete the sentence with the correct tense:',
      sentence: 'She brushes her teeth every morning.',
      verb: 'brush',
      correctAnswer: 'brushes',
      options: ['brush', 'brushed', 'brushes', 'brushing'],
      helpText: 'Hint: "Every morning" tells you this is a repeated action in the present.',
    },
    {
      type: 'form',
      prompt: 'What is the past tense of the verb "eat"?',
      correctAnswer: 'ate',
      helpText: 'Hint: Think about what you would say if you had already finished your food.',
    },
    {
      type: 'form',
      prompt: 'What is the present tense of the verb "ran"?',
      correctAnswer: 'run',
      helpText: 'Hint: This is the base form of the verb.',
    },
    {
      type: 'identify',
      prompt: 'Identify the past tense verb in the sentence:',
      sentence: 'They walked to the store.',
      correctAnswer: 'walked',
      options: ['They', 'walked', 'to', 'store'],
      helpText: 'Hint: The verb has an "-ed" ending, which is a common past tense form.',
    },
    {
      type: 'fill',
      prompt: 'Complete the sentence with the correct tense:',
      sentence: 'Right now, I am doing my homework.',
      verb: 'do',
      correctAnswer: 'am doing',
      options: ['do', 'am doing', 'did', 'done'],
      helpText: 'Hint: "Right now" indicates the action is happening in the present moment.',
    },
    {
      type: 'form',
      prompt: 'What is the past tense of the verb "sing"?',
      correctAnswer: 'sang',
      helpText: 'Hint: This is an irregular verb.',
    },
    {
      type: 'identify',
      prompt: 'Identify the present tense verb in the sentence:',
      sentence: 'Birds fly in the sky.',
      correctAnswer: 'fly',
      options: ['Birds', 'fly', 'in', 'sky'],
      helpText: 'Hint: This is a general truth, so it\'s in the present tense.',
    },
  ];

  // Function to handle player's answer
  const handleAnswer = (answer) => {
    const currentQuestion = questions[currentQuestionIndex];
    let isAnswerCorrect;

    // Normalize answer for comparison
    const normalizedAnswer = String(answer).trim().toLowerCase();
    const normalizedCorrectAnswer = String(currentQuestion.correctAnswer).trim().toLowerCase();

    // Check for "am doing" type answers
    if (currentQuestion.correctAnswer === 'am doing' && normalizedAnswer.includes('am doing')) {
      isAnswerCorrect = true;
    } else {
      isAnswerCorrect = normalizedAnswer === normalizedCorrectAnswer;
    }
    
    setIsCorrect(isAnswerCorrect);
    setShowFeedback(true);

    if (isAnswerCorrect) {
      setScore(score + 1);
    }

    // Move to the next question after a short delay
    setTimeout(() => {
      setShowFeedback(false);
      const nextQuestionIndex = currentQuestionIndex + 1;
      if (nextQuestionIndex < questions.length) {
        setCurrentQuestionIndex(nextQuestionIndex);
      } else {
        // End of game
        setCurrentPage('scorecard');
        // Stop music when the game ends
        if (isMusicPlaying) {
          Tone.Transport.stop();
          Tone.Transport.cancel();
          setIsMusicPlaying(false);
        }
      }
    }, 1500); // 1.5 seconds delay for feedback
  };

  // Function to toggle background music
  const toggleMusic = async () => {
    // Only start the audio context if the user has interacted with the page
    if (Tone.Transport.state !== "started") {
      await Tone.start();
      Tone.Transport.start();
      musicPlayerRef.current.sequence.loop = true;
      musicPlayerRef.current.sequence.loopEnd = '2n';
    }

    if (isMusicPlaying) {
      Tone.Transport.pause();
    } else {
      Tone.Transport.start();
    }
    setIsMusicPlaying(!isMusicPlaying);
  };

  // Function to download the scorecard
  const downloadScorecard = async () => {
    // html2canvas is now loaded via a CDN
    const canvas = await window.html2canvas(scorecardRef.current, { scale: 2 });
    const image = canvas.toDataURL('image/png');
    const link = document.createElement('a');
    link.href = image;
    link.download = `${playerName}_Scorecard.png`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  // Inline SVG icons to replace react-icons
  const DownloadIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/>
    </svg>
  );

  const MusicIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
      <path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/>
    </svg>
  );

  const MusicOffIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
      <path d="M12.5 18H9V5l12-2v8.5"/><path d="m2 2 20 20"/><path d="M18 16c0-1.8-1.5-3-3.2-3"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/>
    </svg>
  );

  const CheckIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
      <polyline points="20 6 9 17 4 12"/>
    </svg>
  );
  
  const XIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
      <path d="M18 6L6 18M6 6l12 12"/>
    </svg>
  );

  // Render the appropriate screen based on the currentPage state
  const renderPage = () => {
    switch (currentPage) {
      case 'intro':
        return (
          <div className="flex flex-col items-center justify-center p-8 bg-white/80 backdrop-blur-sm rounded-3xl shadow-lg">
            <h1 className="text-3xl sm:text-4xl font-extrabold text-slate-800 mb-6 text-center">Tense Titans: Past & Present</h1>
            <p className="text-sm sm:text-base text-slate-600 mb-8 text-center max-w-sm">Welcome to the game! Please enter your name and class to begin your learning adventure.</p>
            <div className="w-full max-w-xs space-y-4">
              <input
                type="text"
                value={playerName}
                onChange={(e) => setPlayerName(e.target.value)}
                placeholder="Enter Your Name"
                className="w-full px-4 py-3 rounded-lg border-2 border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-slate-800"
              />
              <input
                type="text"
                value={playerClass}
                onChange={(e) => setPlayerClass(e.target.value)}
                placeholder="Enter Your Class"
                className="w-full px-4 py-3 rounded-lg border-2 border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-slate-800"
              />
              <button
                onClick={() => {
                  if (playerName && playerClass) {
                    setCurrentPage('game');
                  }
                }}
                disabled={!playerName || !playerClass}
                className="w-full px-6 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition-colors disabled:bg-blue-300 disabled:cursor-not-allowed"
              >
                Start Game
              </button>
            </div>
          </div>
        );

      case 'game':
        const currentQuestion = questions[currentQuestionIndex];
        return (
          <div className="flex flex-col items-center justify-center p-8 bg-white/80 backdrop-blur-sm rounded-3xl shadow-lg w-full max-w-2xl text-center relative">
            {showFeedback && (
              <div className={`absolute inset-0 flex items-center justify-center rounded-3xl z-10 transition-opacity duration-300 ${showFeedback ? 'opacity-100' : 'opacity-0'} ${isCorrect ? 'bg-green-500/80' : 'bg-red-500/80'}`}>
                {isCorrect ? (
                  <CheckIcon size={80} className="text-white drop-shadow-xl" />
                ) : (
                  <XIcon size={80} className="text-white drop-shadow-xl" />
                )}
              </div>
            )}
            <div className="w-full mb-6">
              <div className="text-sm text-slate-500 mb-2">{`Question ${currentQuestionIndex + 1} of ${questions.length}`}</div>
              <div className="w-full bg-slate-200 rounded-full h-2.5">
                <div className="bg-blue-500 h-2.5 rounded-full" style={{ width: `${((currentQuestionIndex + 1) / questions.length) * 100}%` }}></div>
              </div>
            </div>
            <p className="text-xl sm:text-2xl font-semibold text-slate-700 mb-4">{currentQuestion.prompt}</p>
            {currentQuestion.sentence && (
              <p className="text-lg sm:text-xl font-medium text-slate-600 mb-6 px-4">
                {currentQuestion.sentence}
              </p>
            )}
            {currentQuestion.type === 'identify' && (
              <div className="flex flex-wrap justify-center gap-4 mt-4">
                {currentQuestion.options.map((option, index) => (
                  <button
                    key={index}
                    onClick={() => handleAnswer(option)}
                    className="bg-blue-500 text-white px-6 py-3 rounded-xl font-medium shadow-md hover:bg-blue-600 transition-colors transform hover:scale-105"
                  >
                    {option}
                  </button>
                ))}
              </div>
            )}
            {currentQuestion.type === 'fill' && (
              <div className="flex flex-wrap justify-center gap-4 mt-4">
                {currentQuestion.options.map((option, index) => (
                  <button
                    key={index}
                    onClick={() => handleAnswer(option)}
                    className="bg-blue-500 text-white px-6 py-3 rounded-xl font-medium shadow-md hover:bg-blue-600 transition-colors transform hover:scale-105"
                  >
                    {option}
                  </button>
                ))}
              </div>
            )}
            {currentQuestion.type === 'form' && (
              <div className="w-full max-w-sm mt-4">
                <input
                  type="text"
                  placeholder="Type your answer here..."
                  onKeyDown={(e) => {
                    if (e.key === 'Enter') {
                      handleAnswer(e.target.value);
                    }
                  }}
                  className="w-full px-4 py-3 rounded-lg border-2 border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-slate-800"
                />
              </div>
            )}
            <p className="text-sm text-slate-400 mt-6 px-4">{currentQuestion.helpText}</p>
          </div>
        );

      case 'scorecard':
        return (
          <div className="flex flex-col items-center justify-center p-8 bg-white/80 backdrop-blur-sm rounded-3xl shadow-lg w-full max-w-md text-center">
            <div ref={scorecardRef} className="bg-gradient-to-br from-blue-400 to-blue-600 rounded-2xl p-6 text-white shadow-xl w-full">
              <h2 className="text-3xl font-extrabold mb-2">Game Over!</h2>
              <p className="text-lg font-semibold mb-4">Final Scorecard</p>
              <div className="bg-white/20 rounded-lg p-4 mb-4">
                <div className="text-sm font-medium">Player Name:</div>
                <div className="text-xl font-bold">{playerName}</div>
              </div>
              <div className="bg-white/20 rounded-lg p-4 mb-4">
                <div className="text-sm font-medium">Class:</div>
                <div className="text-xl font-bold">{playerClass}</div>
              </div>
              <div className="bg-white/20 rounded-lg p-4">
                <div className="text-sm font-medium">Your Score:</div>
                <div className="text-4xl font-bold mt-1">{score} / {questions.length}</div>
              </div>
            </div>
            <button
              onClick={downloadScorecard}
              className="mt-6 flex items-center px-6 py-3 bg-green-500 text-white font-bold rounded-lg shadow-md hover:bg-green-600 transition-colors transform hover:scale-105"
            >
              <DownloadIcon className="mr-2" /> Download Scorecard
            </button>
          </div>
        );

      default:
        return null;
    }
  };

  return (
    // Add the html2canvas CDN script to the head of the document
    <>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
      <div className="flex flex-col min-h-screen bg-gray-100 items-center justify-center p-4 sm:p-8 font-sans leading-relaxed">
        {/* Background with subtle gradient and animation */}
        <div className="absolute inset-0 bg-gradient-to-br from-indigo-100 via-blue-100 to-white -z-10"></div>
        
        {/* Music toggle button */}
        <button
          onClick={toggleMusic}
          className="fixed top-4 right-4 p-3 bg-slate-800 text-white rounded-full shadow-lg z-20 hover:bg-slate-700 transition-colors"
          aria-label={isMusicPlaying ? "Turn music off" : "Turn music on"}
        >
          {isMusicPlaying ? <MusicOffIcon size={24} /> : <MusicIcon size={24} />}
        </button>
        
        {/* Main game container */}
        <div className="relative w-full max-w-4xl flex items-center justify-center">
          {renderPage()}
        </div>
      </div>
    </>
  );
};

// Export the main component
export default App;
